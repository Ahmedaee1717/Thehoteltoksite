<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Meeting Studio - AI-Powered Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .transcript-line {
            transition: background-color 0.3s;
        }
        .transcript-line:hover {
            background-color: #f3f4f6;
        }
        .sentiment-positive { border-left: 4px solid #10b981; }
        .sentiment-neutral { border-left: 4px solid #6b7280; }
        .sentiment-negative { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-video text-3xl"></i>
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Live Meeting Studio</h1>
                        <p class="text-sm opacity-90" id="meetingTitle">Connecting...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- ATLAS Bot Status -->
                    <div id="atlasBotStatus" class="hidden bg-white/20 backdrop-blur px-4 py-2 rounded-lg">
                        <div class="flex items-center space-x-2">
                            <span id="atlasStatusDot" class="w-3 h-3 bg-gray-400 rounded-full"></span>
                            <span id="atlasStatusText" class="text-sm font-medium">ATLAS Offline</span>
                        </div>
                    </div>
                    <button id="startAtlasBtn" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-robot mr-2"></i>Start ATLAS Bot
                    </button>
                    <div class="text-right">
                        <div class="text-sm opacity-75">Duration</div>
                        <div class="text-lg font-bold" id="meetingDuration">00:00:00</div>
                    </div>
                    <button id="endMeetingBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-stop-circle mr-2"></i>End Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- ATLAS Not Started Alert -->
        <div id="atlasNotStartedAlert" class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg shadow">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl"></i>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-yellow-800">
                        ‚ö†Ô∏è ATLAS Bot Not Started
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        <p>Real-time transcription requires ATLAS bot to be running.</p>
                        <p class="mt-1"><strong>Action Required:</strong> Click the green "ü§ñ Start ATLAS Bot" button at the top-right corner.</p>
                    </div>
                    <div class="mt-3">
                        <button onclick="document.getElementById('startAtlasBtn').scrollIntoView({behavior: 'smooth', block: 'center'}); document.getElementById('startAtlasBtn').classList.add('ring-4', 'ring-green-300', 'animate-pulse'); setTimeout(() => document.getElementById('startAtlasBtn').classList.remove('ring-4', 'ring-green-300', 'animate-pulse'), 3000);" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded text-sm font-medium transition">
                            Show Me the Button ‚Üí
                        </button>
                    </div>
                </div>
                <button onclick="document.getElementById('atlasNotStartedAlert').style.display='none'" class="flex-shrink-0 ml-auto text-yellow-400 hover:text-yellow-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Transcript & AI Co-Pilot -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Live Transcript -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-500 px-6 py-4 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-closed-captioning text-2xl"></i>
                                <div>
                                    <h2 class="text-lg font-semibold">Live Transcript</h2>
                                    <p class="text-sm opacity-90">Real-time speech-to-text with AI</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="autoScrollBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition">
                                    <i class="fas fa-arrows-alt-v mr-1"></i> Auto-scroll
                                </button>
                                <button id="exportBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition">
                                    <i class="fas fa-download mr-1"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="transcriptContainer" class="h-96 overflow-y-auto p-6 space-y-4">
                        <div class="text-center text-gray-400 py-12">
                            <i class="fas fa-microphone-slash text-4xl mb-3"></i>
                            <p>Waiting for speech...</p>
                            <p class="text-sm mt-2">Transcription will appear here in real-time</p>
                        </div>
                    </div>
                </div>

                <!-- AI Co-Pilot Chat -->
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4 text-white flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-robot text-2xl"></i>
                            <div>
                                <h2 class="text-lg font-semibold">AI Co-Pilot</h2>
                                <p class="text-sm opacity-90">Ask anything about the meeting</p>
                            </div>
                        </div>
                        <button id="clearChatBtn" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-sm transition">
                            <i class="fas fa-trash mr-1"></i> Clear
                        </button>
                    </div>
                    <div id="copilotChat" class="h-64 overflow-y-auto p-6 space-y-3 bg-gray-50">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-comments text-3xl mb-2"></i>
                            <p class="text-sm">Ask me anything!</p>
                            <p class="text-xs mt-1">e.g., "Summarize the last 5 minutes"</p>
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex space-x-2">
                            <input 
                                type="text" 
                                id="copilotInput" 
                                placeholder="Ask a question..."
                                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            />
                            <button id="copilotSendBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Insights Dashboard -->
            <div class="space-y-6">
                <!-- Live Sentiment Tracker -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-smile text-green-500 text-xl"></i>
                            <h3 class="font-semibold">Meeting Vibe</h3>
                        </div>
                        <div class="text-3xl" id="currentMood">üòä</div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-green-600">Positive</span>
                                <span id="positivePercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="positiveBar" class="bg-green-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">Neutral</span>
                                <span id="neutralPercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="neutralBar" class="bg-gray-400 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-red-600">Negative</span>
                                <span id="negativePercent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="negativeBar" class="bg-red-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Speaker Talk-Time -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-chart-pie text-blue-500 text-xl"></i>
                        <h3 class="font-semibold">Speaker Participation</h3>
                    </div>
                    <canvas id="talkTimeChart" class="w-full" height="200"></canvas>
                    <div id="speakerStats" class="mt-4 space-y-2">
                        <!-- Speaker stats will be inserted here -->
                    </div>
                </div>

                <!-- Fact-Check Alerts -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        <h3 class="font-semibold">Fact Checks</h3>
                    </div>
                    <div id="factCheckContainer" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-center text-gray-400 py-6">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p class="text-sm">No factual claims detected yet</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="font-semibold mb-4 flex items-center space-x-2">
                        <i class="fas fa-bolt text-yellow-500"></i>
                        <span>Quick Actions</span>
                    </h3>
                    <div class="space-y-2">
                        <button class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-4 py-3 rounded-lg font-medium transition flex items-center justify-between">
                            <span><i class="fas fa-file-alt mr-2"></i>Generate Sparkpage</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white px-4 py-3 rounded-lg font-medium transition flex items-center justify-between">
                            <span><i class="fas fa-tasks mr-2"></i>Extract Action Items</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <button class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-4 py-3 rounded-lg font-medium transition flex items-center justify-between">
                            <span><i class="fas fa-language mr-2"></i>Translate Live</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let meetingId = null;
        let transcriptChunks = [];
        let displayedChunkIds = new Set(); // Track which chunks are already displayed
        let sentimentData = { positive: 0, neutral: 0, negative: 0 };
        let speakerData = {};
        let talkTimeChart = null;
        let autoScroll = true;
        let ws = null;

        // Initialize
        async function init() {
            // Get meeting ID from URL or start new session
            const urlParams = new URLSearchParams(window.location.search);
            meetingId = urlParams.get('meeting') || 'demo_' + Date.now();
            
            document.getElementById('meetingTitle').textContent = `Session ${meetingId}`;
            
            // Initialize Chart.js
            initializeTalkTimeChart();
            
            // Connect to WebSocket for real-time updates
            connectWebSocket();
            
            // Start meeting duration timer
            startDurationTimer();
            
            // Load existing transcript if any
            await loadExistingTranscript();
        }
        
        // Load existing transcript from database
        async function loadExistingTranscript() {
            try {
                // Add 3-second timeout to prevent hanging
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await axios.get(`/meetings/api/live-updates?meeting=${meetingId}`, {
                    signal: controller.signal,
                    timeout: 3000
                });
                
                clearTimeout(timeoutId);
                
                if (response.data.transcripts && response.data.transcripts.length > 0) {
                    response.data.transcripts.forEach(chunk => {
                        addTranscriptChunk(chunk);
                    });
                }
                if (response.data.sentiment) {
                    updateSentiment(response.data.sentiment);
                }
                if (response.data.speakers) {
                    updateSpeakerStats(response.data.speakers);
                }
            } catch (error) {
                console.log('No existing transcript found or API timeout, starting fresh');
            }
        }

        // WebSocket connection for real-time updates
        function connectWebSocket() {
            // Polling disabled - not needed for empty page
            console.log('‚úÖ Polling disabled - page should be static');
            // setInterval(pollForUpdates, 2000);
        }

        // Poll for new transcript chunks
        async function pollForUpdates() {
            try {
                const response = await axios.get(`/meetings/api/live-updates?meeting=${meetingId}`);
                if (response.data.transcripts) {
                    response.data.transcripts.forEach(chunk => {
                        addTranscriptChunk(chunk);
                    });
                }
                if (response.data.sentiment) {
                    updateSentiment(response.data.sentiment);
                }
                if (response.data.speakers) {
                    updateSpeakerStats(response.data.speakers);
                }
            } catch (error) {
                console.error('Poll error:', error);
            }
        }

        // Add transcript chunk to UI
        function addTranscriptChunk(chunk) {
            // Skip if already displayed
            if (displayedChunkIds.has(chunk.id)) {
                return;
            }
            displayedChunkIds.add(chunk.id);
            
            const container = document.getElementById('transcriptContainer');
            
            // Remove empty state
            if (container.querySelector('.text-gray-400')) {
                container.innerHTML = '';
            }
            
            const sentimentClass = `sentiment-${chunk.sentiment || 'neutral'}`;
            
            const chunkDiv = document.createElement('div');
            chunkDiv.className = `transcript-line p-4 rounded-lg border-l-4 ${sentimentClass} bg-white shadow-sm`;
            chunkDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-purple-400 flex items-center justify-center text-white font-bold text-sm">
                            ${chunk.speaker_name ? chunk.speaker_name[0] : '?'}
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-semibold text-gray-900">${chunk.speaker_name || 'Unknown'}</span>
                            <span class="text-xs text-gray-500">${formatTimestamp(chunk.timestamp_ms)}</span>
                        </div>
                        <p class="text-gray-700">${chunk.text}</p>
                        ${chunk.fact_check ? renderFactCheck(chunk.fact_check) : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(chunkDiv);
            
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // Render fact-check tooltip
        function renderFactCheck(factCheck) {
            const iconClass = {
                verified: 'text-green-500 fa-check-circle',
                unverified: 'text-yellow-500 fa-question-circle',
                false: 'text-red-500 fa-times-circle',
                needs_context: 'text-orange-500 fa-exclamation-circle'
            }[factCheck.status] || 'text-gray-500 fa-circle';
            
            return `
                <div class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-start space-x-2">
                        <i class="fas ${iconClass} mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700">${factCheck.summary}</p>
                            ${factCheck.sources ? `
                                <div class="mt-2 flex flex-wrap gap-2">
                                    ${JSON.parse(factCheck.sources).map(url => `
                                        <a href="${url}" target="_blank" class="text-xs text-blue-600 hover:underline">
                                            <i class="fas fa-external-link-alt mr-1"></i>Source
                                        </a>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Update sentiment display
        function updateSentiment(sentiment) {
            const total = sentiment.positive + sentiment.neutral + sentiment.negative;
            if (total === 0) return;
            
            const posPercent = Math.round((sentiment.positive / total) * 100);
            const neuPercent = Math.round((sentiment.neutral / total) * 100);
            const negPercent = Math.round((sentiment.negative / total) * 100);
            
            document.getElementById('positiveBar').style.width = posPercent + '%';
            document.getElementById('neutralBar').style.width = neuPercent + '%';
            document.getElementById('negativeBar').style.width = negPercent + '%';
            
            document.getElementById('positivePercent').textContent = posPercent + '%';
            document.getElementById('neutralPercent').textContent = neuPercent + '%';
            document.getElementById('negativePercent').textContent = negPercent + '%';
            
            // Update mood emoji
            const moodEmoji = posPercent > 50 ? 'üòä' : 
                            negPercent > 40 ? 'üòü' : 
                            'üòê';
            document.getElementById('currentMood').textContent = moodEmoji;
        }

        // Initialize talk-time chart
        function initializeTalkTimeChart() {
            console.log('üé® Initializing Chart.js...');
            const canvas = document.getElementById('talkTimeChart');
            if (!canvas) {
                console.error('‚ùå Canvas element not found!');
                return;
            }
            
            try {
                const ctx = canvas.getContext('2d');
                talkTimeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'
                            ]
                        }]
                    },
                    options: {
                        responsive: false,  // DISABLE responsive to prevent resize loops
                        maintainAspectRatio: true,
                        animation: false,  // DISABLE animations
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log('‚úÖ Chart.js initialized successfully');
            } catch (error) {
                console.error('‚ùå Chart.js initialization failed:', error);
            }
        }

        // Update speaker stats
        function updateSpeakerStats(speakers) {
            if (!speakers || Object.keys(speakers).length === 0) {
                console.log('‚ö†Ô∏è No speakers to update');
                return;
            }
            
            const sortedSpeakers = Object.entries(speakers).sort((a, b) => b[1].talk_time - a[1].talk_time);
            
            // Update chart only if it exists
            if (talkTimeChart) {
                talkTimeChart.data.labels = sortedSpeakers.map(([name]) => name);
                talkTimeChart.data.datasets[0].data = sortedSpeakers.map(([_, data]) => data.talk_time);
                talkTimeChart.update('none');  // Update without animation
                console.log('üìä Chart updated:', sortedSpeakers.length, 'speakers');
            }
            
            // Update stats list
            const statsContainer = document.getElementById('speakerStats');
            statsContainer.innerHTML = sortedSpeakers.map(([name, data]) => {
                const totalTime = sortedSpeakers.reduce((sum, [_, d]) => sum + d.talk_time, 0);
                const percent = Math.round((data.talk_time / totalTime) * 100);
                
                return `
                    <div class="flex items-center justify-between text-sm">
                        <span class="font-medium text-gray-700">${name}</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${percent}%"></div>
                            </div>
                            <span class="text-gray-600 w-12 text-right">${percent}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Format timestamp
        function formatTimestamp(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        }

        // Start duration timer
        let startTime = Date.now();
        function startDurationTimer() {
            setInterval(() => {
                const elapsed = Date.now() - startTime;
                document.getElementById('meetingDuration').textContent = formatTimestamp(elapsed);
            }, 1000);
        }

        // AI Co-Pilot
        document.getElementById('copilotSendBtn').addEventListener('click', async () => {
            await sendCopilotMessage();
        });
        
        // Allow Enter key to send message
        document.getElementById('copilotInput').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                await sendCopilotMessage();
            }
        });
        
        async function sendCopilotMessage() {
            const input = document.getElementById('copilotInput');
            const question = input.value.trim();
            if (!question) return;
            
            // Add user message
            addCopilotMessage('user', question);
            input.value = '';
            
            try {
                const response = await axios.post('/meetings/api/copilot', {
                    meeting_id: meetingId,
                    question: question
                });
                
                addCopilotMessage('assistant', response.data.answer);
            } catch (error) {
                addCopilotMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        function addCopilotMessage(type, text) {
            const container = document.getElementById('copilotChat');
            
            // Remove empty state
            if (container.querySelector('.text-gray-400')) {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            messageDiv.innerHTML = `
                <div class="max-w-[80%] ${type === 'user' ? 'bg-purple-600 text-white' : 'bg-white border border-gray-200'} rounded-lg px-4 py-2 shadow-sm">
                    <p class="text-sm">${text}</p>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Auto-scroll toggle
        document.getElementById('autoScrollBtn').addEventListener('click', () => {
            autoScroll = !autoScroll;
            document.getElementById('autoScrollBtn').style.opacity = autoScroll ? '1' : '0.5';
        });

        // ============================================
        // ATLAS BOT - Live Transcription
        // ============================================
        let atlasBotId = null;
        let atlasPollingInterval = null;

        async function startAtlasBot() {
            try {
                const startBtn = document.getElementById('startAtlasBtn');
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting ATLAS...';
                
                // Prompt for Zoom meeting URL or ID
                const meetingInput = prompt('Enter Zoom Meeting URL or Meeting ID:', '');
                if (!meetingInput) {
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-robot mr-2"></i>Start ATLAS Bot';
                    return;
                }
                
                // Check if it's a URL or ID
                let payload;
                if (meetingInput.includes('zoom.us')) {
                    payload = { meeting_url: meetingInput, bot_name: 'ATLAS' };
                } else {
                    payload = { meeting_id: meetingInput, bot_name: 'ATLAS' };
                    // Update the page meeting ID
                    meetingId = meetingInput;
                    document.getElementById('meetingTitle').textContent = `Session ${meetingId}`;
                }
                
                console.log('ü§ñ Starting ATLAS bot with:', payload);
                
                const response = await axios.post('/meetings/api/bot/start', payload);
                
                if (response.data.success) {
                    atlasBotId = response.data.bot_id;
                    meetingId = response.data.meeting_id;
                    
                    // Hide the alert
                    document.getElementById('atlasNotStartedAlert').style.display = 'none';
                    
                    // Update UI
                    updateAtlasStatus('connecting', 'ATLAS Connecting...');
                    startBtn.classList.add('hidden');
                    document.getElementById('atlasBotStatus').classList.remove('hidden');
                    
                    // Start polling for status
                    checkAtlasStatus();
                    
                    // Enable aggressive polling for real-time updates
                    startAggressivePolling();
                    
                    alert('‚úÖ ATLAS bot is joining your meeting!\n\nTranscripts will appear in real-time in 10-15 seconds.');
                } else {
                    throw new Error(response.data.error);
                }
            } catch (error) {
                console.error('‚ùå Failed to start ATLAS:', error);
                alert('Failed to start ATLAS: ' + error.message);
                const startBtn = document.getElementById('startAtlasBtn');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-robot mr-2"></i>Start ATLAS Bot';
            }
        }

        async function stopAtlasBot() {
            if (!atlasBotId) return;
            
            try {
                await axios.post('/meetings/api/bot/stop', { bot_id: atlasBotId });
                updateAtlasStatus('offline', 'ATLAS Offline');
                stopAggressivePolling();
                document.getElementById('startAtlasBtn').classList.remove('hidden');
                document.getElementById('atlasBotStatus').classList.add('hidden');
                atlasBotId = null;
                
                alert('‚úÖ ATLAS has left the meeting. Full transcript saved.');
            } catch (error) {
                console.error('‚ùå Failed to stop ATLAS:', error);
            }
        }

        async function checkAtlasStatus() {
            if (!atlasBotId) return;
            
            try {
                const response = await axios.get(`/meetings/api/bot/status/${atlasBotId}`);
                
                if (response.data.success) {
                    const status = response.data.status;
                    
                    if (status === 'in_call_not_recording' || status === 'in_call_recording' || status === 'recording') {
                        updateAtlasStatus('live', 'ATLAS Live üî¥');
                        
                        // Fetch real-time transcript from Recall.ai
                        fetchAtlasTranscript();
                    } else if (status === 'joining_call' || status === 'in_waiting_room') {
                        updateAtlasStatus('connecting', 'ATLAS Connecting...');
                        setTimeout(checkAtlasStatus, 3000); // Check again in 3s
                    } else if (status === 'done' || status === 'fatal') {
                        updateAtlasStatus('offline', 'ATLAS Offline');
                        stopAtlasBot();
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to check ATLAS status:', error);
            }
        }

        function updateAtlasStatus(status, text) {
            const statusDot = document.getElementById('atlasStatusDot');
            const statusText = document.getElementById('atlasStatusText');
            
            statusText.textContent = text;
            
            if (status === 'live') {
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full pulse-dot';
            } else if (status === 'connecting') {
                statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full pulse-dot';
            } else {
                statusDot.className = 'w-3 h-3 bg-gray-400 rounded-full';
            }
        }

        async function fetchAtlasTranscript() {
            if (!atlasBotId) return;
            
            try {
                const response = await axios.get(`/meetings/api/bot/transcript/${atlasBotId}`);
                
                if (response.data.success) {
                    console.log('üìù Fetched transcript:', response.data.words, 'words');
                    
                    // Reload the live updates to get new transcripts
                    const updatesResponse = await axios.get(`/meetings/api/live-updates?meeting=${meetingId}&since=0`);
                    
                    if (updatesResponse.data.transcripts && updatesResponse.data.transcripts.length > 0) {
                        updatesResponse.data.transcripts.forEach(chunk => {
                            if (!displayedChunkIds.has(chunk.id)) {
                                addTranscriptChunk(chunk);
                            }
                        });
                        
                        updateSentiment(updatesResponse.data.sentiment);
                        updateSpeakers(updatesResponse.data.speakers);
                    }
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Error fetching ATLAS transcript:', error);
            }
        }

        function startAggressivePolling() {
            // Poll every 2 seconds for real-time updates
            if (atlasPollingInterval) {
                clearInterval(atlasPollingInterval);
            }
            
            atlasPollingInterval = setInterval(async () => {
                try {
                    // Fetch new transcript from Recall.ai
                    if (atlasBotId) {
                        await fetchAtlasTranscript();
                    }
                    
                    const response = await axios.get(`/meetings/api/live-updates?meeting=${meetingId}&since=0`);
                    
                    if (response.data.transcripts && response.data.transcripts.length > 0) {
                        response.data.transcripts.forEach(chunk => {
                            if (!displayedChunkIds.has(chunk.id)) {
                                addTranscriptChunk(chunk);
                            }
                        });
                    }
                    if (response.data.sentiment) {
                        updateSentiment(response.data.sentiment);
                    }
                    if (response.data.speakers) {
                        updateSpeakerStats(response.data.speakers);
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Polling error:', error);
                }
            }, 2000); // Every 2 seconds
            
            console.log('‚úÖ Aggressive polling enabled (every 2 seconds)');
        }

        function stopAggressivePolling() {
            if (atlasPollingInterval) {
                clearInterval(atlasPollingInterval);
                atlasPollingInterval = null;
                console.log('üõë Aggressive polling stopped');
            }
        }

        // Event Listeners for ATLAS
        document.getElementById('startAtlasBtn').addEventListener('click', startAtlasBot);
        document.getElementById('endMeetingBtn').addEventListener('click', stopAtlasBot);

        // Auto-discover active bot on page load
        async function autoDiscoverBot() {
            if (!meetingId || meetingId.startsWith('demo_')) return;
            
            // Extract Zoom meeting ID from session ID
            const zoomMeetingId = meetingId.replace(/^zoom_/, '').replace(/_\d+$/, '');
            
            try {
                console.log('üîç Checking for active bot for meeting:', zoomMeetingId);
                const response = await axios.get(`/meetings/api/bot/active/${zoomMeetingId}`);
                
                if (response.data.success) {
                    console.log('‚úÖ Found active bot:', response.data.bot_id);
                    atlasBotId = response.data.bot_id;
                    
                    // Update UI
                    updateAtlasStatus('live', 'ATLAS Live üî¥');
                    document.getElementById('startAtlasBtn').classList.add('hidden');
                    document.getElementById('atlasBotStatus').classList.remove('hidden');
                    
                    // Start polling
                    checkAtlasStatus();
                    startAggressivePolling();
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è No active bot found:', error.response?.data?.error);
            }
        }
        
        // Run auto-discovery after page loads
        setTimeout(autoDiscoverBot, 1000);

        // Initialize on load - ONLY ONCE
        let hasInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded fired');
            
            if (hasInitialized) {
                console.warn('‚ö†Ô∏è Init already called, skipping');
                return;
            }
            
            hasInitialized = true;
            
            try {
                init();
            } catch (error) {
                console.error('‚ùå Init error:', error);
            }
        });
    </script>
</body>
</html>
